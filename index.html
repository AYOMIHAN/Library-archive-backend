<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTA Study Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 mt-10">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Upload Material</h2>

        <div class="space-y-4">
            
            <input type="text" id="course_code" placeholder="Course Code (e.g. MTS 101)" 
                   class="w-full p-3 border rounded bg-gray-50">

            <input type="text" id="title" placeholder="File Title (e.g. Algebra)" 
                   class="w-full p-3 border rounded bg-gray-50">

            <input type="text" id="owner_dept" placeholder="Owner Dept (e.g. IDD)" 
                   class="w-full p-3 border rounded bg-gray-50">

            <div class="grid grid-cols-2 gap-2">
                <select id="level" class="p-3 border rounded bg-gray-50">
                    <option value="100">100 L</option>
                    <option value="200">200 L</option>
                    <option value="300">300 L</option>
                    <option value="400">400 L</option>
                    <option value="500">500 L</option>
                </select>
                <select id="semester" class="p-3 border rounded bg-gray-50">
                    <option value="1">Harmattan</option>
                    <option value="2">Rain</option>
                </select>
            </div>

            <input type="file" id="fileInput" accept="application/pdf" 
                   class="w-full p-2 border rounded">

            <button type="button" onclick="startUpload()" id="submitBtn"
                    class="w-full bg-blue-600 text-white font-bold p-3 rounded hover:bg-blue-700">
                üöÄ Upload Material
            </button>
            
            <div id="status" class="text-center font-bold text-sm mt-4 min-h-[20px]"></div>
        </div>
    </div>

    <script>
        // 1. SETUP KEYS
        const SUPABASE_URL = "https://tfjxfmjcmynwwhslzvdy.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmanhmbWpjbXlud3doc2x6dmR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxOTExNzEsImV4cCI6MjA4MDc2NzE3MX0.9T3c3b18rczwWTYKE8387PfIqueKzA4rkbLR4TYYxcc"; 
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. MAIN UPLOAD FUNCTION
        async function startUpload() {
            const status = document.getElementById('status');
            const btn = document.getElementById('submitBtn');
            const file = document.getElementById('fileInput').files[0];

            if (!file) {
                status.innerText = "‚ö†Ô∏è Please select a file first!";
                status.style.color = "red";
                return;
            }

            // Lock the button
            btn.disabled = true;
            btn.innerText = "Wait...";

            try {
                // A. GATHER DATA
                status.innerText = "‚è≥ Preparing...";
                status.style.color = "gray";

                const metadata = {
                    course_code: document.getElementById('course_code').value.toUpperCase().trim(),
                    title: document.getElementById('title').value.trim(),
                    owner_dept: document.getElementById('owner_dept').value.toUpperCase().trim(),
                    level: parseInt(document.getElementById('level').value),
                    semester: document.getElementById('semester').value,
                };
                
                // Simple validation
                if(!metadata.course_code || !metadata.title || !metadata.owner_dept) {
                    throw new Error("Please fill in all text fields.");
                }

                // B. GENERATE SECURE URL
                const fileExt = file.name.split('.').pop();
                const safeName = metadata.course_code.replace(/[^a-z0-9]/gi, '');
                const fileName = `${metadata.owner_dept}/${metadata.level}/${safeName}_${Date.now()}.${fileExt}`;

                // Call Netlify Backend
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'upload', 
                        file_key: fileName, 
                        file_type: file.type 
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error("Backend connection failed: " + errText);
                }

                const data = await response.json();
                if (!data.url) throw new Error("No URL returned from backend.");

                // C. UPLOAD TO CLOUDFLARE
                status.innerText = "‚òÅÔ∏è Uploading file...";
                await fetch(data.url, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });

                // D. SAVE TO DATABASE
                status.innerText = "üíæ Saving info...";
                const { error } = await supabase.from('study_materials').insert([{
                    ...metadata,
                    visible_to: [metadata.owner_dept],
                    file_key: fileName,
                    file_size: (file.size / 1024 / 1024).toFixed(2) + " MB"
                }]);

                if (error) throw error;

                // E. SUCCESS
                status.innerText = "‚úÖ Upload Successful!";
                status.style.color = "green";
                btn.innerText = "Done";

            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå Error: " + err.message;
                status.style.color = "red";
                btn.innerText = "Try Again";
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
